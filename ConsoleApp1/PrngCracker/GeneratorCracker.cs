using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Diagnostics;
using DualEcPRNGDemo.MyImplementation;

namespace DualEcPRNGDemo.PrngCracker
{
    public class GeneratorCracker
    {
        private readonly Queue<BigInteger> _randomValues;

        private readonly ConcurrentQueue<List<Point>> _generatedPointBatches;

        public GeneratorCracker(BigInteger first)
        {
            var curve = Curve.GetP256NistCurve();
            _randomValues = new Queue<BigInteger>();

            _generatedPointBatches = new PointGenerator(curve, first).GeneratePoints();
        }

        public void FeedNextRandomValue(BigInteger randomValue)
        {
            _randomValues.Enqueue(randomValue);

            FindRealPoint(_generatedPointBatches);
        }

        private void FindRealPoint(ConcurrentQueue<List<Point>> batches)
        {
            var randomValue = _randomValues.Dequeue();
            var stopwatch = new Stopwatch();
            stopwatch.Start();
            while (batches.TryDequeue(out List<Point> batch))
            {
                foreach (var point in batch)
                {
                    var generator = new Generator(point);
                    var generatedValue = generator.GetNextRandomValue(false);

                    if (generatedValue != randomValue) continue;

                    Console.WriteLine("Cracked");
                    Console.WriteLine($"{stopwatch.Elapsed}");
                    return;
                }
            }
        }
    }
}
