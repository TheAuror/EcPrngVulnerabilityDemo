using System.Linq;

namespace DualEcPRNGDemo.MyImplementation
{
    public class Generator
    {
        private Point _pointP;
        private Point _pointQ;

        private BigInteger _state;

        public Generator(int initialState = 1)
        {
            _state = 1;
            var curve = Curve.GetP256NistCurve();

            _pointQ = curve.CreatePointAt(NistConstants.P256.Qx, NistConstants.P256.Qy) * initialState;
            _pointP = _pointQ * Constants.P256.Secret;
        }

        public Generator(Point pointQ)
        {
            var curve = Curve.GetP256NistCurve();
            _pointQ = curve.CreatePointAt(NistConstants.P256.Qx, NistConstants.P256.Qy);
            _pointP = _pointQ * Constants.P256.Secret;
            _state = (pointQ * Constants.P256.Secret).X;
        }

        private void StepPointP() => _pointP = _pointP * _state;
        private void StepPointQ() => _pointQ = _pointQ * _state;

        public BigInteger GetNextRandomValue(bool stepPointP = true)
        {
            Point newQ;

            if (stepPointP)
            {
                Point newP = _pointP * _state;
                _state = newP.X;
            }

            newQ = _pointQ * _state;

            var qx = newQ.X;
            var phiQx = qx.AsByteArray.Value;

            phiQx = phiQx.Take(phiQx.Length - Constants.P256.CutBytes).ToArray();

            return new BigInteger(phiQx);
        }

        public void Reseed(BigInteger seed)
        {
            _state = seed;
        }
    }
}