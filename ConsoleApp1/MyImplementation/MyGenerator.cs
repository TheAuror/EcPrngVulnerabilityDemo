using System.Linq;

namespace DualEcPRNGDemo.MyImplementation
{
    public class MyGenerator
    {
        private MyPoint _pointP;
        private MyPoint _pointQ;

        private MyBigInteger _state;

        public MyGenerator(int initialState = 1)
        {
            _state = 1;
            var curve = MyCurve.GetP256NistCurve();

            _pointQ = curve.CreatePointAt(NistConstants.P256.Qx, NistConstants.P256.Qy) * initialState;
            _pointP = _pointQ * MyConstants.P256.Secret;
        }

        public MyGenerator(MyPoint pointQ)
        {
            var curve = MyCurve.GetP256NistCurve();
            _pointQ = curve.CreatePointAt(NistConstants.P256.Qx, NistConstants.P256.Qy);
            _pointP = _pointQ * MyConstants.P256.Secret;
            _state = (pointQ * MyConstants.P256.Secret).X;
        }

        private void StepPointP() => _pointP = _pointP * _state;
        private void StepPointQ() => _pointQ = _pointQ * _state;

        public MyBigInteger GetNextRandomValue(bool stepPointP = true)
        {
            MyPoint newP = _pointP;
            MyPoint newQ;
            if (stepPointP)
            {
                newP = _pointP * _state;
                _state = newP.X;
            }



            newQ = _pointQ * _state;

            var qx = newQ.X;

            var phiQx = qx.AsByteArray.Value;

            phiQx = phiQx.Take(phiQx.Length - MyConstants.P256.CutBytes).ToArray();

            return new MyBigInteger(phiQx);
        }

        public void Reseed(MyBigInteger seed)
        {
            _state = seed;
        }
    }
}