using System;
using System.Collections.Generic;
using System.Linq;

namespace DualEcPRNGDemo.MyImplementation
{
    public class Curve
    {
        public readonly BigInteger A;
        private readonly BigInteger _b;
        public readonly BigInteger Prime;

        public Curve(BigInteger a, BigInteger b, BigInteger prime)
        {
            A = a;
            _b = b;
            Prime = prime;
        }

        public static Curve GetP256NistCurve()
        {
            return new Curve(NistConstants.P256.A, NistConstants.P256.B, NistConstants.P256.Prime);
        }

        public bool IsPointOnCurve(Point point)
        {
            return IsPointOnCurve(point.X, point.Y);
        }

        public bool IsPointOnCurve(BigInteger x, BigInteger y)
        {
            var result = x.ModPow(3, Prime) + A * x + _b - y.ModPow(2, Prime);
            if (result % Prime == new BigInteger(0f)) return true;
            throw new Exception();
        }

        public Point CreatePointAt(BigInteger x, BigInteger y)
        {
            IsPointOnCurve(x, y);
            return new Point(x, y, this);
        }

        public List<Point> GetPointsAt(BigInteger x)
        {
            var ySquared = (x*x*x%Prime + (A * x) + _b) % Prime;
            var y = ySquared.ModSqrt(Prime);

            var result = new List<Point>();
            
            y.Where(e => IsPointOnCurve(x, e))
             .ForEach(e => result.Add(CreatePointAt(x, e)));

            return result;
        }
    }
}
